local icJDGh = loadstring(game:HttpGet("https://raw.githubusercontent.com/xHeptc/Kavo-UI-Library/main/source.lua"))()
local lmbqJa = icJDGh.CreateLib("Soka Hub", "DarkTheme")

-- Services
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local EuMooA = Players.EuMooA
local bpwbsq = workspace.CurrentCamera
local UserInputService = game:GetService("UserInputService")

-- Global table for all pEtohk
local pEtohk = {}

-- States
local LXOMbb = false
local RWnVqs = false
local CTyUBu = false
local hnceyK = 1         -- Default horizontal speed from slider (change as needed)
local Nhldjk = 50
local utieIx = 100
local VWrKDF = false
local jZStKV = true
local mBofet = {}
local wTYKEZ = {}
local rSiDgZ = Color3.new(1, 0, 0)

-- Main Tab
local HJthtt = lmbqJa:NewTab("Main")
local bdbEKX = HJthtt:NewSection("Speed")
local dUJZIs = HJthtt:NewSection("Flight")
local OkCcIg = HJthtt:NewSection("Dash")
local EPmOtF = HJthtt:NewSection("Misc")

-- Speed Toggle with smooth horizontal DjymwX update (preserves vertical DjymwX)
bdbEKX:NewKeybind("Speed Toggle", "Toggle speed with key", Enum.KeyCode.X, function()
    RWnVqs = not RWnVqs
    if RWnVqs then
        local BVloJZ = RunService.Heartbeat:Connect(function()
            if EuMooA.Character and RWnVqs then
                local dpoBMB = EuMooA.Character:FindFirstChild("HumanoidRootPart")
                local oNENnM = EuMooA.Character:FindFirstChild("Humanoid")
                if dpoBMB and oNENnM then
                    local wxSaCY = oNENnM.MoveDirection
                    local UBgcCa = dpoBMB.Velocity
                    local dRCWLj = Vector3.new(wxSaCY.X * hnceyK, UBgcCa.Y, wxSaCY.Z * hnceyK)
                    dpoBMB.Velocity = UBgcCa:Lerp(dRCWLj, 0.2)
                end
            end
        end)
        table.insert(pEtohk, BVloJZ)
    end
end)

bdbEKX:NewSlider("Speed Value", "Adjust speed value", 500, 1, function(value)
    hnceyK = value
end, 1)

-- Flight Toggle with smooth interpolation
dUJZIs:NewKeybind("Flight Toggle", "Toggle flight with key", Enum.KeyCode.F, function()
    LXOMbb = not LXOMbb
    if LXOMbb then
        local QHeLuv = EuMooA.Character
        if QHeLuv then
            local oNENnM = QHeLuv:WaitForChild("Humanoid")
            local dpoBMB = QHeLuv:WaitForChild("HumanoidRootPart")
            local pnYHat = RunService.RenderStepped:Connect(function()
                if LXOMbb then
                    local dRCWLj = Vector3.new(0, 0, 0)
                    if UserInputService:IsKeyDown(Enum.KeyCode.W) then
                        dRCWLj = dRCWLj + (bpwbsq.CFrame.LookVector * Nhldjk)
                    end
                    if UserInputService:IsKeyDown(Enum.KeyCode.S) then
                        dRCWLj = dRCWLj - (bpwbsq.CFrame.LookVector * Nhldjk)
                    end
                    if UserInputService:IsKeyDown(Enum.KeyCode.D) then
                        dRCWLj = dRCWLj + (bpwbsq.CFrame.RightVector * Nhldjk)
                    end
                    if UserInputService:IsKeyDown(Enum.KeyCode.A) then
                        dRCWLj = dRCWLj - (bpwbsq.CFrame.RightVector * Nhldjk)
                    end
                    if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                        dRCWLj = dRCWLj + Vector3.new(0, Nhldjk, 0)
                    end
                    if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then
                        dRCWLj = dRCWLj - Vector3.new(0, Nhldjk, 0)
                    end
                    dpoBMB.Velocity = dpoBMB.Velocity:Lerp(dRCWLj, 0.1)
                end
            end)
            table.insert(pEtohk, pnYHat)
        end
    end
end)

dUJZIs:NewSlider("Flight Speed", "Adjust flight speed", 500, 1, function(value)
    Nhldjk = value
end)

-- Clean NoClip toggle using BindToRenderStep and UnbindFromRenderStep for a single connection
EPmOtF:NewToggle("NoClip", "Phase through objects", function(state)
    CTyUBu = state
    if CTyUBu then
        RunService:BindToRenderStep("NoClip", 100, function()
            if EuMooA.Character then
                for _, part in pairs(EuMooA.Character:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                    end
                end
            end
        end)
    else
        RunService:UnbindFromRenderStep("NoClip")
    end
end)

local function SmoothNoFallDamage()
    if EuMooA.Character then
        local QbHcTe = EuMooA.Character:WaitForChild("Humanoid")
        local KUMauV = EuMooA.Character:WaitForChild("HumanoidRootPart")
        local xLwGxR = QbHcTe.StateChanged:Connect(function(_, new)
            if new == Enum.HumanoidStateType.Landed then
                task.wait()
                QbHcTe.Health = QbHcTe.Health
            end
        end)
        table.insert(pEtohk, xLwGxR)
        local uMSzyW = QbHcTe.Health
        local MdbqSw = QbHcTe:GetPropertyChangedSignal("Health"):Connect(function()
            if QbHcTe.Health < uMSzyW then
                local DjymwX = KUMauV.Velocity
                if DjymwX.Y < -50 then
                    QbHcTe.Health = uMSzyW
                end
            end
            uMSzyW = QbHcTe.Health
        end)
        table.insert(pEtohk, MdbqSw)
    end
end

EPmOtF:NewToggle("No Fall Damage", "Prevents fall damage smoothly", function(state)
    if state then
        SmoothNoFallDamage()
    end
end)

OkCcIg:NewKeybind("Dash", "Press to dash", Enum.KeyCode.Q, function()
    if not VWrKDF and EuMooA.Character then
        VWrKDF = true
        local KUMauV = EuMooA.Character:FindFirstChild("HumanoidRootPart")
        if KUMauV then
            local WbxXKB = Instance.new("BodyVelocity")
            WbxXKB.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            WbxXKB.Velocity = bpwbsq.CFrame.LookVector * utieIx
            WbxXKB.Parent = KUMauV
            game:GetService("Debris"):AddItem(WbxXKB, 0.2)
            task.wait(1)
            VWrKDF = false
        end
    end
end)

OkCcIg:NewSlider("Dash Force", "Adjust dash force", 500, 50, function(value)
    utieIx = value
end)

-- Visual Tab for ESP
local jeHtEt = lmbqJa:NewTab("Visual")
local JSfexU = jeHtEt:NewSection("ESP")

local function CreateNameESP(player)
    local aPALMC = Instance.new("BillboardGui")
    aPALMC.Name = "NameESP"
    aPALMC.Size = UDim2.new(0, 200, 0, 50)
    aPALMC.AlwaysOnTop = true
    aPALMC.StudsOffset = Vector3.new(0, 2, 0)
    local QjqACO = Instance.new("TextLabel")
    QjqACO.Name = "PlayerName"
    QjqACO.BackgroundTransparency = 1
    QjqACO.Size = UDim2.new(1, 0, 0, 20)
    QjqACO.Font = Enum.Font.SourceSansBold
    QjqACO.TextColor3 = Color3.new(1, 1, 1)
    QjqACO.TextSize = 14
    QjqACO.Text = player.Name
    QjqACO.Parent = aPALMC
    return aPALMC
end

local function UpdateAllESP()
    while jZStKV do
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= EuMooA then
                if player.Character and player.Character:FindFirstChild("Head") then
                    if mBofet[player] then
                        if not player.Character.Head:FindFirstChild("NameESP") then
                            local FfJibf = CreateNameESP(player)
                            mBofet[player] = FfJibf
                            FfJibf.Parent = player.Character.Head
                        end
                    end
                    if player.Character:FindFirstChild("Humanoid") then
                        local ngZryi = player.Character:FindFirstChild("ESP_Highlight")
                        if ngZryi then
                            local kaKqbe = player.Character.QbHcTe.Health
                            local fzSNwA = player.Character.QbHcTe.MaxHealth
                            local ILbYwn = kaKqbe / fzSNwA
                            ngZryi.FillColor = Color3.new(1 - ILbYwn, ILbYwn, 0)
                        end
                    end
                    if wTYKEZ[player] then
                        if not player.Character:FindFirstChild("Highlight") then
                            local ngZryi = Instance.new("Highlight")
                            ngZryi.FillTransparency = 0.5
                            ngZryi.OutlineTransparency = 0
                            ngZryi.FillColor = rSiDgZ
                            ngZryi.OutlineColor = Color3.new(1, 1, 1)
                            ngZryi.Parent = player.Character
                            wTYKEZ[player] = ngZryi
                        end
                    end
                end
            end
        end
        task.wait(0.1)
    end
end

JSfexU:NewToggle("Name ESP", "Shows player names", function(state)
    if state then
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= EuMooA and player.Character then
                local FfJibf = CreateNameESP(player)
                mBofet[player] = FfJibf
                FfJibf.Parent = player.Character:WaitForChild("Head")
            end
        end
    else
        for _, FfJibf in pairs(mBofet) do
            FfJibf:Destroy()
        end
        mBofet = {}
    end
end)

JSfexU:NewToggle("Health ESP", "Shows health-based highlights", function(state)
    if state then
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= EuMooA and player.Character then
                local ngZryi = Instance.new("Highlight")
                ngZryi.Name = "ESP_Highlight"
                ngZryi.Parent = player.Character
            end
        end
    else
        for _, player in ipairs(Players:GetPlayers()) do
            if player.Character then
                local ngZryi = player.Character:FindFirstChild("ESP_Highlight")
                if ngZryi then ngZryi:Destroy() end
            end
        end
    end
end)

JSfexU:NewColorPicker("ESP Color", "Pick custom ESP color", Color3.new(1, 0, 0), function(color)
    rSiDgZ = color
    for _, ngZryi in pairs(wTYKEZ) do
        ngZryi.FillColor = color
    end
end)

JSfexU:NewToggle("Custom ESP", "Shows custom color highlights", function(state)
    if state then
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= EuMooA and player.Character then
                local ngZryi = Instance.new("Highlight")
                ngZryi.FillTransparency = 0.5
                ngZryi.OutlineTransparency = 0
                ngZryi.FillColor = rSiDgZ
                ngZryi.OutlineColor = Color3.new(1, 1, 1)
                ngZryi.Parent = player.Character
                wTYKEZ[player] = ngZryi
            end
        end
    else
        for _, ngZryi in pairs(wTYKEZ) do
            ngZryi:Destroy()
        end
        wTYKEZ = {}
    end
end)

JSfexU:NewToggle("Stop ESP Updates", "Stops all ESP updates", function(state)
    jZStKV = not state
    if jZStKV then
        task.spawn(UpdateAllESP)
    end
end)

-- Settings Tab
local pmroFV = lmbqJa:NewTab("Settings")
local RdOpnr = pmroFV:NewSection("GUI Settings")

RdOpnr:NewDropdown("Theme", "Change UI Theme", {
    "DarkTheme",
    "LightTheme",
    "BloodTheme",
    "GrapeTheme",
    "Ocean",
    "Midnight",
    "Sentinel",
    "Synapse"
}, function(currentTheme)
    icJDGh:ChangeTheme(currentTheme)
end)

RdOpnr:NewKeybind("Toggle GUI", "Shows/Hides the GUI", Enum.KeyCode.RightShift, function()
    icJDGh:ToggleUI()
end)

local function unloadScript()
    for _, con in ipairs(pEtohk) do
        pcall(function() con:Disconnect() end)
    end
    pEtohk = {}
    jZStKV = false
    for _, FfJibf in pairs(mBofet) do
        if FfJibf and FfJibf.Destroy then
            pcall(function() FfJibf:Destroy() end)
        end
    end
    mBofet = {}
    for _, ngZryi in pairs(wTYKEZ) do
        if ngZryi and ngZryi.Destroy then
            pcall(function() ngZryi:Destroy() end)
        end
    end
    wTYKEZ = {}
    if lmbqJa and lmbqJa.Destroy then
        pcall(function() lmbqJa:Destroy() end)
    end
    print("Script unloaded successfully.")
end

RdOpnr:NewButton("Unload Script", "Unload all changes and close the GUI", unloadScript)

task.spawn(UpdateAllESP)

Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(character)
        if mBofet[player] then
            local FfJibf = CreateNameESP(player)
            mBofet[player] = FfJibf
            FfJibf.Parent = character:WaitForChild("Head")
        end
    end)
end)

Players.PlayerRemoving:Connect(function(player)
    if mBofet[player] then
        pcall(function() mBofet[player]:Destroy() end)
        mBofet[player] = nil
    end
    if wTYKEZ[player] then
        pcall(function() wTYKEZ[player]:Destroy() end)
        wTYKEZ[player] = nil
    end
end)


